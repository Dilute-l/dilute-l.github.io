<!DOCTYPE html>

<html>
    <head>
        <title>Dilute's Blog</title>
        <meta charset="utf-8">

        <link rel="stylesheet" href="/css/main.css">

        <script src="/js/main.js"></script>

        <style>
        
            .menu{
                top: 0;
                z-index:2;
                /* background-color: #CCCCCC; */
                position: absolute;
                left: 0;
                height: 100px;
                width: 99.95%;
            }

            .openButton{
                position: absolute;
                right: 0;
            }

            .menu img{
                height: 50px;
            }

            /* .menu:focus .menu_content{
                animation: show_menu 0.3s forwards ease; 
            }

            .menu:focus .close_button{
                animation: show_menu 0.3s forwards ease;
            }

            @keyframes show_menu{
                0%{
                    margin-top: -110%;
                }

                100%{
                    margin-top: 0;
                }
            }

            .close_button:focus+.menu_content{
                animation: hide_menu 0.3s forwards ease;
            }

            .close_button:focus{
                animation: hide_menu 0.3s forwards ease;
            }

            @keyframes hide_menu{
                0%{
                    margin-top: 0px;
                }

                100%{
                    margin-top: -110%;
                }
            } */

            .menu_content{
                /* display: none; */
                position: absolute;
                background-color: #FFFFFF;
                margin-top: -110%;
                text-align: center;
                width: 100%;
                height: calc(100vh);
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                z-index: 2;
            }

            .close_button{
                position: absolute;
                right: 0;
                margin-top: -110%;
                height: 100px;
                z-index: 3;
            }

            .bottom{
                margin: 100px 100px 0 0;
                text-align: center;
                color: gray;
            }

            .avatar_frame{
                box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
                border-radius: 100%;
                overflow: hidden;
                height: 200px;
                width:200px;
                position: relative;
                left: 0;
                right: 0;
                margin: auto;
            }

            .avatar_frame img{
                height: 100%;
                width: 100%;
            }

            .avatar{
                position: relative;
                text-align: center;
                height: 350px;
                top: 50px;
            }

            .name_logo{
                position: relative;
                text-align: center;
                height: 60px;
            }

            .name_logo h1{
                color: pink;
                font-size: 60px;
            }

            .portals{
                position: absolute;
                color: pink;
                text-align: center;
                border-radius: 25px;
                height: 50px;
                width: 100px;
                border: 2px solid pink;
                z-index: 1145114;
                font-size: 25px;
                line-height: 50px;
            }

        </style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    </head>

    <body>
        <div class = "menu">
            <div class = "openButton">
                <img src = "https://dilute.xyz/images/MENU-OPEN.png">
            </div>
            <div class = "close_button">
                <img src = "https://dilute.xyz/images/MENU-CLOSE.png">
            </div>
            <div class = "menu_content">
                <div class = "avatar">
                    <div class = "avatar_frame">
                        <img src = "https://dilute.xyz/images/avatar.png">
                    </div>
                    <div class = "name_logo">
                        <h1> Dilute </h1>
                    </div>
                </div>

                <div style = "margin-top: 50px;">
                    <a href = "https://dilute.xyz">
                        <div class = "portals" style = "margin-left: calc(50vw - 230px)">
                            主页
                        </div>
                    </a>
                    <a href = "https://dilute.xyz/archives">
                        <div class = "portals" style = "margin-left: calc(50vw - 110px)">
                            归档
                        </div>
                    </a>
                    <a href = "https://dilute.xyz/friends">
                        <div class = "portals" style = "margin-left: calc(50vw + 10px)">
                            朋友
                        </div>
                    </a>
                    <a href = "https://dilute.xyz/about">
                        <div class = "portals" style = "margin-left: calc(50vw + 130px)">
                            关于
                        </div>
                    </a>
                </div>

                <div style = "height: 100px"> </div>

                
                <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=320 src="//music.163.com/outchain/player?type=0&id=7567348850&auto=1&height=430"></iframe>
            </div> 
       
        </div>

        <html>
    <head><meta name="generator" content="Hexo 3.9.0">
        <style>
            .cover_page {
                height: 300px;
                /* line-height: 940px; */
                margin: 0 auto;
                position: relative;
                /* z-index: -2; */
            }

            .cover_page p{
                position: absolute;
                bottom: 0;
                width: 100%;
                text-align: center;
            }

            .cover_page img{
                width: 50%;
            }
        </style>
    </head>

    <body>
        <div class="cover_page">
            <p>
                <a href="https://dilute.xyz"> <img src="https://dilute.xyz/images/logo.png"> </a>
            </p>
            <!-- diltue.xyz -->
        </div>

        <div class="text_page">
            <h1> fhq Treap与区间操作 </h1>
        </div>

        <div class="text_page">
            <p>​        前段时间在机房里几个大爷的墙裂安利下学了发$fhq\ treap$ 于是就顺带着把$fhq\ treap$的区间操作给学了（比$Splay$的好理解多了）</p>
<p>似乎这么一点字太少了？那我放张图=-=</p>
<p><img src="dilute.coding.me/images/wxw_walking.gif" alt></p>
<a id="more"></a>
<h2 id="Ⅰ前置芝士-——-fhq-Treap-（非旋Treap）"><a href="#Ⅰ前置芝士-——-fhq-Treap-（非旋Treap）" class="headerlink" title="Ⅰ前置芝士 —— fhq Treap （非旋Treap）"></a>Ⅰ前置芝士 —— fhq Treap （非旋Treap）</h2><p><del>我这篇文章是来讲区间操作的</del></p>
<p><del>不是来教你fhq treap的</del></p>
<p><del>所以你如果不会fhq treap的话自己找别的讲稿把</del></p>
<p><del>其实主要是因为我自己一大半也是感性理解的啦</del></p>
<p><del>好吧还是贴个代码把</del></p>
<p>咳咳咳，没错，所以这个部分就是让你们来背代码的</p>
<h4 id="merge"><a href="#merge" class="headerlink" title="$merge$"></a>$merge$</h4><p>$merge(a, b)$的作用就是把根为b的树向根为a的树合并，并且返回合并出来的树的根。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0</span> || b == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    <span class="keyword">if</span>(t[a].w &gt; t[b].w)&#123;</span><br><span class="line">        t[a].rc = merge(t[a].rc, b);</span><br><span class="line">        push_up(a);</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        t[b].lc = merge(a, t[b].lc);</span><br><span class="line">        push_up(b);</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>恩，就这么短。</p>
<h4 id="split"><a href="#split" class="headerlink" title="$split$"></a>$split$</h4><p>$split(a, b, c, d)$的作用是把根为a的子树分裂成两棵树$c, d$，并且$c$子树中是前$b$个元素。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(<span class="keyword">int</span> cur, <span class="keyword">int</span> k, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cur == <span class="number">0</span>)&#123;</span><br><span class="line">        a = b = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(k &lt;= t[t[cur].lc].size)&#123;</span><br><span class="line">        b = cur;</span><br><span class="line">        split(t[cur].lc, k, a, t[b].lc);</span><br><span class="line">        push_up(b);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a = cur;</span><br><span class="line">        split(t[cur].rc, k - t[t[cur].lc].size - <span class="number">1</span>, t[a].rc, b);</span><br><span class="line">        push_up(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他核心操作？$\tan 90^{\text{o}}$。</p>
<p>因为$fhq\ treap$ 的核心操作就这俩玩意儿。</p>
<h2 id="Ⅱ-如何操作"><a href="#Ⅱ-如何操作" class="headerlink" title="Ⅱ 如何操作"></a>Ⅱ 如何操作</h2><p>显然，如果你要对一个区间进行操作，你就得先从它的根节点开始搞事情</p>
<p>那么你如何获得它的根节点呢？</p>
<p>如果你要操作一个$[l, r]$的区间</p>
<p>不管你怎么操作</p>
<p>肯定存在一个很方便的办法：弄出来一个表示$[l, r]$这个区间的子树。</p>
<p>说到子树，如果你学懂了$fhq$，那么你肯定能想到$split$操作</p>
<p><del>说到split，我就想到了唐僧与世俗split开去西天取经，明年年初，中美合拍，文体两开花，关注，谢谢支持。</del></p>
<p>在前一行，你什么都没看到，恩，就这样。</p>
<p>（瞬间正经）好，我们考虑如何$split$出来表示$[l , r]$区间的子树。</p>
<p>首先，我们首先$split$出来一个$size$为$l - 1$的子树，那剩下了第二棵子树，那么第二棵子树代表的显然就是$[l, n]$，然后你再$split$出来一个$size$为$r - l + 1$的子树，那么你这次$split$出来的子树代表的区间就是$[l, r]$啦</p>
<p>操作完之后我们就会得到3棵子树，你在第二棵上面做玩你想要的操作之后把子树$merge$回去就行了</p>
<p>比方说区间翻转的代码长这样↓</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x, y, z;</span><br><span class="line">    split(root, l - <span class="number">1</span>, x, y);</span><br><span class="line">    <span class="keyword">int</span> rt = y;</span><br><span class="line">    split(rt, r - l + <span class="number">1</span>, y, z);</span><br><span class="line">    t[y].lazy ^= <span class="number">1</span>;</span><br><span class="line">    root = merge(x, merge(y, z));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于区间翻转的操作我会在下面讲↓</p>
<h2 id="Ⅲ-例题"><a href="#Ⅲ-例题" class="headerlink" title="Ⅲ 例题"></a>Ⅲ 例题</h2><h4 id="洛谷P3391-【模板】文艺平衡树（Splay）"><a href="#洛谷P3391-【模板】文艺平衡树（Splay）" class="headerlink" title="洛谷P3391 【模板】文艺平衡树（Splay）"></a>洛谷P3391 【模板】文艺平衡树（Splay）</h4><p>原题：<a href="https://www.luogu.org/problemnew/show/P3391" target="_blank" rel="noopener">&gt;Here&lt;</a></p>
<p>这边的区间翻转我们应当用打懒标的方式实现，然后每次操作的时候记得$pushdown$一下就行啦</p>
<p>怎么得到区间刚刚已经讲过了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ll long long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 2147483647</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">inp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = getchar();</span><br><span class="line">    <span class="keyword">while</span>(c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span>)</span><br><span class="line">        c = getchar();</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>)&#123;</span><br><span class="line">        sum = sum * <span class="number">10</span> + c - <span class="string">'0'</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fhq_Treap</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">T</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> lc;</span><br><span class="line">        <span class="keyword">int</span> rc;</span><br><span class="line">        <span class="keyword">bool</span> lazy;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="keyword">int</span> w;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">    &#125;t[<span class="number">100010</span>];</span><br><span class="line">    <span class="keyword">int</span> root;</span><br><span class="line">    <span class="keyword">int</span> cnt;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        root = cnt = <span class="number">0</span>;</span><br><span class="line">        t[<span class="number">0</span>].lc = t[<span class="number">0</span>].rc = t[<span class="number">0</span>].lazy = t[<span class="number">0</span>].size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_up</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        t[cur].size = t[t[cur].lc].size + t[t[cur].rc].size + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_down</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!t[cur].lazy)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        <span class="built_in">std</span>::swap(t[cur].lc, t[cur].rc);</span><br><span class="line">        t[t[cur].lc].lazy ^= <span class="number">1</span>;</span><br><span class="line">        t[t[cur].rc].lazy ^= <span class="number">1</span>;</span><br><span class="line">        t[cur].lazy = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(<span class="keyword">int</span> cur, <span class="keyword">int</span> k, <span class="keyword">int</span> &amp;x, <span class="keyword">int</span> &amp;y)</span></span>&#123;</span><br><span class="line">        push_down(cur);</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)&#123;</span><br><span class="line">            x = y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(t[t[cur].lc].size &gt;= k)&#123;</span><br><span class="line">            y = cur;</span><br><span class="line">            split(t[cur].lc, k, x, t[y].lc);</span><br><span class="line">            push_up(y);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            x = cur;</span><br><span class="line">            split(t[cur].rc, k - t[t[cur].lc].size - <span class="number">1</span>, t[x].rc, y);</span><br><span class="line">            push_up(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> y;</span><br><span class="line">        <span class="keyword">if</span>(y == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        push_down(x);</span><br><span class="line">        push_down(y);</span><br><span class="line">        <span class="keyword">if</span>(t[x].w &gt; t[y].w)&#123;</span><br><span class="line">            t[x].rc = merge(t[x].rc, y);</span><br><span class="line">            push_up(x);</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            t[y].lc = merge(x, t[y].lc);</span><br><span class="line">            push_up(y);</span><br><span class="line">            <span class="keyword">return</span> y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, l - <span class="number">1</span>, x, y);</span><br><span class="line">        <span class="keyword">int</span> rt = y;</span><br><span class="line">        split(rt, r - l + <span class="number">1</span>, y, z);</span><br><span class="line">        t[y].lazy ^= <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// printf("finished split phase.\n");</span></span><br><span class="line">        <span class="comment">// printf("%d %d, %d\n", x, y, z);</span></span><br><span class="line">        rt = merge(y, z);</span><br><span class="line">        <span class="comment">// print(rt);</span></span><br><span class="line">        root = merge(x, rt);</span><br><span class="line">        <span class="comment">// printf("completed reverse.\n");</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        t[++cnt].lazy = <span class="literal">false</span>;</span><br><span class="line">        t[cnt].size = <span class="number">1</span>;</span><br><span class="line">        t[cnt].w = rand();</span><br><span class="line">        t[cnt].v = x;</span><br><span class="line">        t[cnt].lc = t[cnt].rc = <span class="number">0</span>;</span><br><span class="line">        root = merge(root, cnt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        push_down(cur);</span><br><span class="line">        print(t[cur].lc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d "</span>, t[cur].v);</span><br><span class="line">        print(t[cur].rc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    t.init();</span><br><span class="line">    <span class="keyword">int</span> n = inp();</span><br><span class="line">    <span class="keyword">int</span> m = inp();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        t.insert(i);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> l = inp();</span><br><span class="line">        <span class="keyword">int</span> r = inp();</span><br><span class="line">        <span class="comment">// t.print(t.root);</span></span><br><span class="line">        <span class="comment">// putchar('\n');</span></span><br><span class="line">        t.reverse(l, r);</span><br><span class="line">    &#125;</span><br><span class="line">    t.print(t.root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SP4350-QMAX3VN-Gia-tri-lon-nhat-3"><a href="#SP4350-QMAX3VN-Gia-tri-lon-nhat-3" class="headerlink" title="SP4350 QMAX3VN - Giá trị lớn nhất 3"></a>SP4350 QMAX3VN - Giá trị lớn nhất 3</h4><p>原题：<a href="https://www.spoj.com/problems/QMAX3VN/" target="_blank" rel="noopener">&gt;Here&lt;</a></p>
<p><del>这题luogu上面没法用C艹交</del></p>
<p><del>但是fhq treap 这种一堆取址的东西用C弄超级麻烦</del></p>
<p><del>于是我贡献了大量的CE与UKE</del></p>
<p>好的，这题要求资瓷插入以及查询区间最大值</p>
<p>然后插入的话我们split两棵子树，$merge$的时候把新加的元素当做一棵子树并在中间就行了</p>
<p>节点上维护区间最大值就OK了</p>
<p>还是很简单的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ll long long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 2147483647</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ll <span class="title">inp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = getchar();</span><br><span class="line">    ll neg = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="string">'-'</span>)</span><br><span class="line">            neg = <span class="number">-1</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    ll sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>)&#123;</span><br><span class="line">        sum = sum * <span class="number">10</span> + c - <span class="string">'0'</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum * neg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fhq_Treap</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">T</span>&#123;</span></span><br><span class="line">        ll max;</span><br><span class="line">        ll lc;</span><br><span class="line">        ll rc;</span><br><span class="line">        ll size;</span><br><span class="line">        ll v;</span><br><span class="line">        ll w;</span><br><span class="line">    &#125;t[<span class="number">200010</span>];</span><br><span class="line">    ll cnt, root;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        root = cnt = <span class="number">0</span>;</span><br><span class="line">        t[<span class="number">0</span>] = &#123;-INF, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ll <span class="title">create</span><span class="params">(ll v)</span></span>&#123;</span><br><span class="line">        ll v0 = <span class="built_in">std</span>::max(v, <span class="number">0l</span>l);</span><br><span class="line">        t[++cnt] = &#123;v, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, v, rand()&#125;;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push_up</span><span class="params">(ll cur)</span></span>&#123;</span><br><span class="line">        t[cur].max = <span class="built_in">std</span>::max(t[cur].v, <span class="built_in">std</span>::max(t[t[cur].lc].max, t[t[cur].rc].max));</span><br><span class="line">        t[cur].size = t[t[cur].lc].size + t[t[cur].rc].size + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// printf("cur = %lld, max = %lld\n", cur, t[cur].max);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ll <span class="title">merge</span><span class="params">(ll a, ll b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(a == <span class="number">0</span> || b == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        <span class="keyword">if</span>(t[a].w &gt; t[b].w)&#123;</span><br><span class="line">            t[a].rc = merge(t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            t[b].lc = merge(a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(ll cur, ll k, ll &amp;a, ll &amp;b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)&#123;</span><br><span class="line">            a = b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(k &lt;= t[t[cur].lc].size)&#123;</span><br><span class="line">            b = cur;</span><br><span class="line">            split(t[cur].lc, k, a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a = cur;</span><br><span class="line">            split(t[cur].rc, k - t[t[cur].lc].size - <span class="number">1</span>, t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(ll pos, ll v)</span></span>&#123;</span><br><span class="line">        ll x, y;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        <span class="comment">// printf("Insert x = %lld, y = %lld\n", x, y);</span></span><br><span class="line">        root = merge(merge(x, create(v)), y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(ll pos)</span></span>&#123;</span><br><span class="line">        ll x, y, z;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, <span class="number">1</span>, y, z);</span><br><span class="line">        root = merge(x, z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prll</span><span class="params">(ll cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        prll(t[cur].lc);</span><br><span class="line">        <span class="comment">// printf("t[%lld] v = %lld ls= %lld rs= %lld sum= %lld tot= %lld lc= %lld rc= %lld\n", cur, t[cur].v, t[cur].ls, t[cur].rs, t[cur].sum, t[cur].tot, t[cur].lc, t[cur].rc);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"t[%lld] = lc = %lld, rc = %lld, max = %lld, v = %lld\n"</span>, cur, t[cur].lc, t[cur].rc, t[cur].max, t[cur].v);</span><br><span class="line">        prll(t[cur].rc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ll <span class="title">query</span><span class="params">(ll l, ll r)</span></span>&#123;</span><br><span class="line">        ll x, y, z;</span><br><span class="line">        split(root, l - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, r - l + <span class="number">1</span>, y, z);</span><br><span class="line">        <span class="comment">// prll(y);</span></span><br><span class="line">        ll ret = t[y].max;</span><br><span class="line">        root = merge(merge(x, y), z);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(ll x)</span></span>&#123;</span><br><span class="line">        root = merge(root, create(x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    t.init();</span><br><span class="line">    ll m = inp();</span><br><span class="line">    <span class="comment">// printf("%d\n", m);</span></span><br><span class="line">    <span class="comment">// t.prll(t.root);</span></span><br><span class="line">    <span class="keyword">for</span>(ll i = <span class="number">1</span>; i &lt;= m; i++)&#123;</span><br><span class="line">        <span class="keyword">char</span> type = getchar();</span><br><span class="line">        <span class="keyword">while</span>(type != <span class="string">'A'</span> &amp;&amp; type != <span class="string">'Q'</span>)</span><br><span class="line">            type = getchar();</span><br><span class="line">        <span class="keyword">if</span>(type == <span class="string">'A'</span>)&#123;</span><br><span class="line">            ll x = inp();</span><br><span class="line">            ll pos = inp();</span><br><span class="line">            t.insert(pos, x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ll l = inp();</span><br><span class="line">            ll r = inp();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, t.query(l, r));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf("i = %lld, finished %c\n", i, type);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SP4487-GSS6-Can-you-answer-these-queries-VI"><a href="#SP4487-GSS6-Can-you-answer-these-queries-VI" class="headerlink" title="SP4487 GSS6 - Can you answer these queries VI"></a>SP4487 GSS6 - Can you answer these queries VI</h4><p>原题：<a href="https://www.spoj.com/problems/GSS6/" target="_blank" rel="noopener">&gt;Here&lt;</a></p>
<p>这题就比较毒瘤啦</p>
<p>资瓷区间查询最大子段和，插入，删除，修改。</p>
<p>区间最大字段和的话我们可以参照线段树做法，一个节点上维护左端点开始的，右端点开始的还有整个的最大字段和，以及区间的和。</p>
<p>$pushup$因为两段元素中间还多了个自己这个节点，所以会麻烦不少</p>
<p>删除的时候只要$split$出来之后中间那段不$merge$回去就行了</p>
<p>修改的时候只要把中间那段修改权值一下就行了</p>
<p>只是写完之后修锅要好长时间呢…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ll long long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 2147483647</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">inp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = getchar();</span><br><span class="line">    <span class="keyword">int</span> neg = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="string">'-'</span>)</span><br><span class="line">            neg = <span class="number">-1</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>)&#123;</span><br><span class="line">        sum = sum * <span class="number">10</span> + c - <span class="string">'0'</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum * neg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fhq_Treap</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">T</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> ls;</span><br><span class="line">        <span class="keyword">int</span> rs;</span><br><span class="line">        <span class="keyword">int</span> sum;</span><br><span class="line">        <span class="keyword">int</span> tot;</span><br><span class="line">        <span class="keyword">int</span> lc;</span><br><span class="line">        <span class="keyword">int</span> rc;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        <span class="keyword">int</span> w;</span><br><span class="line">    &#125;t[<span class="number">200010</span>];</span><br><span class="line">    <span class="keyword">int</span> cnt, root;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        root = cnt = <span class="number">0</span>;</span><br><span class="line">        t[<span class="number">0</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, -INF, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v0 = <span class="built_in">std</span>::max(v, <span class="number">0l</span>l);</span><br><span class="line">        t[++cnt] = &#123;v0, v0, v, v, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, v, rand()&#125;;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push_up</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(t[cur].lc == <span class="number">0</span> &amp;&amp; t[cur].rc == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> v2 = <span class="built_in">std</span>::max(t[cur].v, <span class="number">0l</span>l);</span><br><span class="line">            t[cur].sum = t[cur].tot = t[cur].v;</span><br><span class="line">            t[cur].ls = t[cur].rs = v2;</span><br><span class="line">            t[cur].size = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        t[cur].tot = t[t[cur].lc].tot + t[t[cur].rc].tot + t[cur].v;</span><br><span class="line">        t[cur].ls = <span class="built_in">std</span>::max(t[t[cur].lc].tot + t[cur].v + t[t[cur].rc].ls, t[t[cur].lc].ls);</span><br><span class="line">        t[cur].rs = <span class="built_in">std</span>::max(t[t[cur].rc].tot + t[cur].v + t[t[cur].lc].rs, t[t[cur].rc].rs);</span><br><span class="line"></span><br><span class="line">        t[cur].sum = <span class="built_in">std</span>::max(<span class="built_in">std</span>::max(t[t[cur].lc].sum, t[t[cur].rc].sum), t[t[cur].lc].rs + t[cur].v + t[t[cur].rc].ls);</span><br><span class="line">        t[cur].size = t[t[cur].lc].size + t[t[cur].rc].size + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// printf("push up %lld | max&#123;%lld %lld %lld&#125; = %d\n", cur, t[t[cur].lc].sum, t[t[cur].rc].sum, t[t[cur].lc].rs + t[cur].v + t[t[cur].rc].ls, t[cur].sum);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(a == <span class="number">0</span> || b == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        <span class="keyword">if</span>(t[a].w &gt; t[b].w)&#123;</span><br><span class="line">            t[a].rc = merge(t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            t[b].lc = merge(a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(<span class="keyword">int</span> cur, <span class="keyword">int</span> k, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)&#123;</span><br><span class="line">            a = b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(k &lt;= t[t[cur].lc].size)&#123;</span><br><span class="line">            b = cur;</span><br><span class="line">            split(t[cur].lc, k, a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a = cur;</span><br><span class="line">            split(t[cur].rc, k - t[t[cur].lc].size - <span class="number">1</span>, t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        <span class="comment">// printf("Insert x = %lld, y = %lld\n", x, y);</span></span><br><span class="line">        root = merge(merge(x, create(v)), y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, <span class="number">1</span>, y, z);</span><br><span class="line">        <span class="keyword">int</span> v0 = <span class="built_in">std</span>::max(v, <span class="number">0l</span>l);</span><br><span class="line">        t[y] = &#123;v0, v0, v, v, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, v, t[y].w&#125;;</span><br><span class="line">        root = merge(merge(x, y), z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> pos)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, <span class="number">1</span>, y, z);</span><br><span class="line">        root = merge(x, z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        print(t[cur].lc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"t[%lld] v = %lld ls= %lld rs= %lld sum= %lld tot= %lld lc= %lld rc= %lld\n"</span>, cur, t[cur].v, t[cur].ls, t[cur].rs, t[cur].sum, t[cur].tot, t[cur].lc, t[cur].rc);</span><br><span class="line">        print(t[cur].rc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, l - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, r - l + <span class="number">1</span>, y, z);</span><br><span class="line">        <span class="comment">// print(y);</span></span><br><span class="line">        <span class="keyword">int</span> ret = t[y].sum;</span><br><span class="line">        root = merge(merge(x, y), z);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        root = merge(root, create(x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    t.init();</span><br><span class="line">    <span class="keyword">int</span> n = inp();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        t.build(inp());</span><br><span class="line">    <span class="keyword">int</span> m = inp();</span><br><span class="line">    <span class="comment">// printf("%d\n", m);</span></span><br><span class="line">    <span class="comment">// t.print(t.root);</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)&#123;</span><br><span class="line">        <span class="keyword">char</span> type = getchar();</span><br><span class="line">        <span class="keyword">while</span>(type != <span class="string">'I'</span> &amp;&amp; type != <span class="string">'D'</span> &amp;&amp; type != <span class="string">'R'</span> &amp;&amp; type != <span class="string">'Q'</span>)</span><br><span class="line">            type = getchar();</span><br><span class="line">        <span class="keyword">if</span>(type == <span class="string">'I'</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> pos = inp();</span><br><span class="line">            <span class="keyword">int</span> x = inp();</span><br><span class="line">            t.insert(pos, x);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">'D'</span>)&#123;</span><br><span class="line">            t.del(inp());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">'R'</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> pos = inp();</span><br><span class="line">            <span class="keyword">int</span> x = inp();</span><br><span class="line">            t.modify(pos, x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> l = inp();</span><br><span class="line">            <span class="keyword">int</span> r = inp();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, t.query(l, r));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// printf("i = %lld, finished %c\n", i, type);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="NOI2005-维护数列"><a href="#NOI2005-维护数列" class="headerlink" title="[NOI2005]维护数列"></a>[NOI2005]维护数列</h4><p>原题：<a href="https://www.luogu.org/problemnew/show/P2042" target="_blank" rel="noopener">&gt;Here&lt;</a></p>
<p>这题可以认为就是前三题加起来了</p>
<p>不过有一点要注意</p>
<p>在维护最大字段和的时候如果左右子树是反的那么会导致错误</p>
<p>所以我们不能像我给的文艺平衡树板子那样子写区间翻转</p>
<p>具体怎么做还是看代码把（</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ll long long</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 2147483647</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">inp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = getchar();</span><br><span class="line">    <span class="keyword">int</span> neg = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &lt; <span class="string">'0'</span> || c &gt; <span class="string">'9'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(c == <span class="string">'-'</span>)</span><br><span class="line">            neg = <span class="number">-1</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>)&#123;</span><br><span class="line">        sum = sum * <span class="number">10</span> + c - <span class="string">'0'</span>;</span><br><span class="line">        c = getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum * neg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fhq_Treap</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">T</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> ls;</span><br><span class="line">        <span class="keyword">int</span> rs;</span><br><span class="line">        <span class="keyword">int</span> sum;</span><br><span class="line">        <span class="keyword">int</span> tot;</span><br><span class="line">        <span class="keyword">int</span> lc;</span><br><span class="line">        <span class="keyword">int</span> rc;</span><br><span class="line">        <span class="keyword">int</span> size;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        <span class="keyword">int</span> w;</span><br><span class="line">        <span class="keyword">int</span> lazy;</span><br><span class="line">        <span class="keyword">bool</span> reverse;</span><br><span class="line">    &#125;t[<span class="number">5000010</span>];</span><br><span class="line">    <span class="keyword">int</span> cnt, root;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        root = cnt = <span class="number">0</span>;</span><br><span class="line">        t[<span class="number">0</span>] = (T)&#123;<span class="number">0</span>, <span class="number">0</span>, -INF, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -INF, <span class="literal">false</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(<span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v0 = <span class="built_in">std</span>::max(v, <span class="number">0</span>);</span><br><span class="line">        t[++cnt] = (T)&#123;v0, v0, v, v, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, v, rand(), -INF, <span class="literal">false</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push_up</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(t[cur].lc == <span class="number">0</span> &amp;&amp; t[cur].rc == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> v2 = <span class="built_in">std</span>::max(t[cur].v, <span class="number">0</span>);</span><br><span class="line">            t[cur].sum = t[cur].tot = t[cur].v;</span><br><span class="line">            t[cur].ls = t[cur].rs = v2;</span><br><span class="line">            t[cur].size = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        t[cur].tot = t[t[cur].lc].tot + t[t[cur].rc].tot + t[cur].v;</span><br><span class="line">        t[cur].ls = <span class="built_in">std</span>::max(t[t[cur].lc].tot + t[cur].v + t[t[cur].rc].ls, t[t[cur].lc].ls);</span><br><span class="line">        t[cur].rs = <span class="built_in">std</span>::max(t[t[cur].rc].tot + t[cur].v + t[t[cur].lc].rs, t[t[cur].rc].rs);</span><br><span class="line"></span><br><span class="line">        t[cur].sum = <span class="built_in">std</span>::max(<span class="built_in">std</span>::max(t[t[cur].lc].sum, t[t[cur].rc].sum), t[t[cur].lc].rs + t[cur].v + t[t[cur].rc].ls);</span><br><span class="line">        t[cur].size = t[t[cur].lc].size + t[t[cur].rc].size + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// printf("push up %d | max&#123;%d %d %d&#125; = %d\n", cur, t[t[cur].lc].sum, t[t[cur].rc].sum, t[t[cur].lc].rs + t[cur].v + t[t[cur].rc].ls, t[cur].sum);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">push_down</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(t[cur].lazy != -INF)&#123;</span><br><span class="line">			<span class="keyword">int</span> v0 = <span class="built_in">std</span>::max(t[cur].lazy, <span class="number">0</span>);</span><br><span class="line">			t[t[cur].lc].ls = t[t[cur].lc].rs = v0 * t[t[cur].lc].size;</span><br><span class="line">			t[t[cur].rc].ls = t[t[cur].rc].rs = v0 * t[t[cur].rc].size;</span><br><span class="line">			t[t[cur].lc].sum = <span class="built_in">std</span>::max(t[cur].lazy, t[cur].lazy * t[t[cur].lc].size);</span><br><span class="line">			t[t[cur].rc].sum = <span class="built_in">std</span>::max(t[cur].lazy, t[cur].lazy * t[t[cur].rc].size);</span><br><span class="line">			</span><br><span class="line">			t[t[cur].lc].tot = t[cur].lazy * t[t[cur].lc].size;</span><br><span class="line">			t[t[cur].rc].tot = t[cur].lazy * t[t[cur].rc].size;</span><br><span class="line">			</span><br><span class="line">			t[t[cur].lc].lazy = t[cur].lazy; </span><br><span class="line">			t[t[cur].rc].lazy = t[cur].lazy;</span><br><span class="line">			t[t[cur].lc].v = t[t[cur].rc].v = t[cur].lazy;</span><br><span class="line">			</span><br><span class="line">			t[cur].lazy = -INF;</span><br><span class="line">			t[cur].reverse = <span class="literal">false</span>; </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(t[cur].reverse)&#123;</span><br><span class="line">	        <span class="built_in">std</span>::swap(t[t[cur].lc].lc, t[t[cur].lc].rc);</span><br><span class="line">	        <span class="built_in">std</span>::swap(t[t[cur].rc].lc, t[t[cur].rc].rc);</span><br><span class="line">	        <span class="built_in">std</span>::swap(t[t[cur].lc].ls, t[t[cur].lc].rs);</span><br><span class="line">	        <span class="built_in">std</span>::swap(t[t[cur].rc].ls, t[t[cur].rc].rs);</span><br><span class="line">			t[t[cur].lc].reverse ^= <span class="number">1</span>;</span><br><span class="line">	        t[t[cur].rc].reverse ^= <span class="number">1</span>;</span><br><span class="line">	        t[cur].reverse = <span class="literal">false</span>;</span><br><span class="line">		&#125; </span><br><span class="line">        t[<span class="number">0</span>] = (T)&#123;<span class="number">0</span>, <span class="number">0</span>, -INF, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -INF, <span class="literal">false</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(a == <span class="number">0</span> || b == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> a + b;</span><br><span class="line">        push_down(a);</span><br><span class="line">        push_down(b);</span><br><span class="line">        <span class="keyword">if</span>(t[a].w &gt; t[b].w)&#123;</span><br><span class="line">            t[a].rc = merge(t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            t[b].lc = merge(a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(<span class="keyword">int</span> cur, <span class="keyword">int</span> k, <span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)&#123;</span><br><span class="line">            a = b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        push_down(cur);</span><br><span class="line">        <span class="keyword">if</span>(k &lt;= t[t[cur].lc].size)&#123;</span><br><span class="line">            b = cur;</span><br><span class="line">            split(t[cur].lc, k, a, t[b].lc);</span><br><span class="line">            push_up(b);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a = cur;</span><br><span class="line">            split(t[cur].rc, k - t[t[cur].lc].size - <span class="number">1</span>, t[a].rc, b);</span><br><span class="line">            push_up(a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> rt)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y;</span><br><span class="line">        split(root, pos, x, y);</span><br><span class="line">        root = merge(merge(x, rt), y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> len, <span class="keyword">int</span> v)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, len, y, z);</span><br><span class="line">        t[y].ls = t[y].rs = <span class="built_in">std</span>::max(v, <span class="number">0</span>) * t[y].size;</span><br><span class="line">        t[y].tot = t[y].size * v;</span><br><span class="line">    	t[y].sum = <span class="built_in">std</span>::max(v, v * t[y].size);</span><br><span class="line">    	t[y].lazy = v;</span><br><span class="line">    	t[y].v = v;</span><br><span class="line">        root = merge(merge(x, y), z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, len, y, z);</span><br><span class="line">        root = merge(x, z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> cur)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        push_down(cur);</span><br><span class="line">        print(t[cur].lc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"t[%d] v = %d ls= %d rs= %d sum= %d tot= %d lc= %d rc= %d\n"</span>, cur, t[cur].v, t[cur].ls, t[cur].rs, t[cur].sum, t[cur].tot, t[cur].lc, t[cur].rc);</span><br><span class="line">        print(t[cur].rc);</span><br><span class="line">        push_up(cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y, z;</span><br><span class="line">        split(root, l - <span class="number">1</span>, x, y);</span><br><span class="line">        split(y, len, y, z);</span><br><span class="line">        <span class="comment">// print(y);</span></span><br><span class="line">        <span class="keyword">int</span> ret = t[y].tot;</span><br><span class="line">        root = merge(merge(x, y), z);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        root = merge(root, create(x));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">int</span> x, y, z;</span><br><span class="line">    	split(root, pos - <span class="number">1</span>, x, y);</span><br><span class="line">    	split(y, len, y, z);</span><br><span class="line">    	t[y].reverse ^= <span class="number">1</span>;</span><br><span class="line">    	<span class="built_in">std</span>::swap(t[y].lc, t[y].rc);</span><br><span class="line">    	<span class="built_in">std</span>::swap(t[y].ls, t[y].rs);</span><br><span class="line">    	root = merge(merge(x, y), z);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    t.init();</span><br><span class="line">    <span class="keyword">int</span> n = inp();</span><br><span class="line">    <span class="keyword">int</span> m = inp();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        t.build(inp());</span><br><span class="line">    <span class="comment">// printf("%d\n", m);</span></span><br><span class="line">    <span class="comment">// t.print(t.root);</span></span><br><span class="line">    <span class="keyword">char</span> type[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)&#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%s"</span>, type);</span><br><span class="line">		<span class="keyword">if</span>(type[<span class="number">0</span>] == <span class="string">'I'</span>)&#123;</span><br><span class="line">			<span class="keyword">int</span> pos = inp();</span><br><span class="line">			<span class="keyword">int</span> cnt = inp();</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">vector</span> &lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">			<span class="keyword">int</span> rt = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= cnt; j++)</span><br><span class="line">				rt = t.merge(rt, t.create(inp()));</span><br><span class="line">            t.insert(pos, rt);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type[<span class="number">0</span>] == <span class="string">'D'</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> l = inp();</span><br><span class="line">            <span class="keyword">int</span> len = inp();</span><br><span class="line">			t.del(l, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type[<span class="number">0</span>] == <span class="string">'R'</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> pos = inp();</span><br><span class="line">            <span class="keyword">int</span> len = inp();</span><br><span class="line">            t.reverse(pos, len);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(type[<span class="number">0</span>] == <span class="string">'M'</span> &amp;&amp; type[<span class="number">2</span>] == <span class="string">'K'</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> pos = inp();</span><br><span class="line">            <span class="keyword">int</span> len = inp();</span><br><span class="line">            <span class="keyword">int</span> x = inp();</span><br><span class="line">            t.modify(pos, len, x);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(type[<span class="number">0</span>] == <span class="string">'G'</span>)&#123;</span><br><span class="line">			<span class="keyword">int</span> pos = inp();</span><br><span class="line">			<span class="keyword">int</span> len = inp();</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, t.query(pos, len));</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, t.t[t.root].sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// t.print(t.root);</span></span><br><span class="line">        <span class="comment">// putchar('\n');</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Ⅳ-与其他相似算法的比较"><a href="#Ⅳ-与其他相似算法的比较" class="headerlink" title="Ⅳ 与其他相似算法的比较"></a>Ⅳ 与其他相似算法的比较</h2><h4 id="Splay"><a href="#Splay" class="headerlink" title="Splay"></a>Splay</h4><p>Splay的作用跟$fhq\ Treap$差不多，都是可以维护区间操作，但是个人认为$fhq$优于$Splay$，理由有二</p>
<ul>
<li>好写，代码短</li>
<li>易于理解</li>
</ul>
<p>而且，$fhq$的常数跟$Splay$差不多</p>
<p>但是$fhq$的缺点也是显著，就是不能写LCT。</p>
<h4 id="其他平衡树"><a href="#其他平衡树" class="headerlink" title="其他平衡树"></a>其他平衡树</h4><p>不得不说$fhq$和$Splay$两个可以维护区间操作的平衡树在常数方面完全可以以变态大的常数打爆其他平衡树（甚至包括$set$）</p>
<p>所以，如果不写区间操作，$set$都比$fhq$快。</p>
<p>完结撒花～～</p>

        </div>
    </body>
</html>

        <div class = "bottom">
            <br/>

            <a href = "https://user.qzone.qq.com/2312866507/infocenter">QQ</a>

            <p style = "display:inline"> | </p>

            <a href = "https://codeforces.com/profile/Dilute">Codeforces</a>

            <p style = "display:inline"> | </p>

            <a href = "https://www.luogu.com.cn/user/36362">Luogu</a>

            <p style = "display:inline"> | </p>

            <a href = "https://github.com/Dilute-l">Github</a> 

            <br/>
            
            本站由 <a href = "https://hexo.io/zh-cn/"> Hexo </a> 驱动，使用 Azurus 作为主题。
            
            <br/>
            <br/>
            <br/>
            <br/>

        </div>

    </body>
        
    <script>
        function moveTop(obj, num) {
            clearInterval(obj.timeOut)
            obj.timeOut = setInterval(function () {
                let step = (num - parseInt(getComputedStyle(obj, null).marginTop)) / 10
                step = step > 0 ? Math.ceil(step) : Math.floor(step)
                obj.style.marginTop = parseInt(getComputedStyle(obj, null).marginTop) + step + 'px';
            },15)
        }

        let openb = document.querySelector('.openButton')
        let close = document.querySelector('.close_button')
        let div = document.querySelector('.menu_content')
        let original = parseInt(getComputedStyle(div, null).marginTop)

        openb.style.marginLeft = '200px'

        openb.addEventListener('click',function () {
            moveTop(div, 0)
            moveTop(close, 0);
        })

        close.addEventListener('click', function(){
            moveTop(div, original)
            moveTop(close, original);
        })

        
    </script>
</html>